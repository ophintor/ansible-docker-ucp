Set-PowerCLIConfiguration -InvalidCertificateAction ignore -Confirm:$false
{% for datastore in datastores %}
Connect-VIServer {{ vcenter_hostname }} -User {{ vcenter_user }} -Password {{ vcenter_pass }}
$datastore=Get-Datastore -Name "{{ datastore }}" -Refresh:$true
New-PSDrive -Location $datastore -name ds{{ datastore }} -PSProvider VimDatastore -Root "\"
Copy-DatastoreItem -Item ds{{ datastore }}:\{{ dummy_vm_prefix }}-{{ datastore }}\*.vmx -Destination ds{{ datastore }}:\dockvols\
Copy-DatastoreItem -Item ds{{ datastore }}:\{{ dummy_vm_prefix }}-{{ datastore }}\*.vmsd -Destination ds{{ datastore }}:\dockvols\
Copy-DatastoreItem -Item ds{{ datastore }}:\{{ dummy_vm_prefix }}-{{ datastore }}\*.vmdk -Destination ds{{ datastore }}:\dockvols\
New-VM -VMFilePath "[{{ datastore }}] dockvols/{{ dummy_vm_prefix }}-{{ datastore }}.vmx" -Name {{ dummy_vm_prefix }}-in-dockvols-{{ datastore }} -VMHost {{ esxi_host }}
Disconnect-VIServer * -Confirm:$false
{% endfor %}
Connect-VIServer {{ vcenter_hostname }} -User {{ vcenter_user }} -Password {{ vcenter_pass }}
{% for datastore in datastores %}
$vm=Get-VM -Name '{{ dummy_vm_prefix }}-{{ datastore }}'
echo $vm
Remove-VM -VM $vm -DeletePermanently -Confirm:$false
{% endfor %}
Disconnect-VIServer * -Confirm:$false


